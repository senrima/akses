<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Invoice Cepat</title>

    <!-- Memuat Font dan CSS dari CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Style Kustom & Optimasi -->
    <style>
        body { font-family: 'Poppins', sans-serif; }
        [x-cloak] { display: none !important; }

        /* --- OPTIMASI: Animasi untuk Skeleton Loader --- */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .animate-shimmer {
            animation: shimmer 2s infinite linear;
            background: linear-gradient(to right, #eff1f3 4%, #e2e2e2 25%, #eff1f3 36%);
            background-size: 1000px 100%;
        }
        /* ------------------------------------------- */
    </style>

    <!-- SCRIPT UTAMA APLIKASI -->
    <script>
        // ‼️ GANTI DENGAN URL WEB APP GOOGLE APPS SCRIPT ANDA
        const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbyp8pRlxRcaPQ_mOC-mA7VRrbr6vintkrkIGJEBPur-huRm3D-iXnuhwTPLeSO0FcXQ/exec";

        function crudApp() {
            return {
                isLoading: true,
                invoices: [],
                isModalOpen: false,
                isDeleteModalOpen: false,
                itemToDelete: null,
                modal: { isEdit: false, id_invoice: null, nama: '', status: '' },
                searchQuery: '',
                currentPage: 1,
                itemsPerPage: 10,

                // Pencarian mencakup kolom ID Invoice, Nama, Status
                get filteredInvoices() {
                    if (this.searchQuery === '') {
                        return this.invoices;
                    }
                    this.currentPage = 1;
                    const searchLower = this.searchQuery.toLowerCase();
                    return this.invoices.filter(item =>
                        item.ID_Invoice.toString().toLowerCase().includes(searchLower) ||
                        item.Nama.toLowerCase().includes(searchLower) ||
                        item.Status.toLowerCase().includes(searchLower)
                    );
                },

                get paginatedData() {
                    const start = (this.currentPage - 1) * this.itemsPerPage;
                    const end = start + this.itemsPerPage;
                    return this.filteredInvoices.slice(start, end);
                },

                get totalPages() {
                    return Math.ceil(this.filteredInvoices.length / this.itemsPerPage);
                },

                init() {
                    this.loadInvoices();
                },

                nextPage() {
                    if (this.currentPage < this.totalPages) {
                        this.currentPage++;
                    }
                },
                prevPage() {
                    if (this.currentPage > 1) {
                        this.currentPage--;
                    }
                },

                async callApi(payload) {
                    try {
                        const finalPayload = { ...payload, kontrol: 'invoice' };
                        const response = await fetch(API_ENDPOINT, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                            body: JSON.stringify(finalPayload),
                            mode: 'cors'
                        });
                        if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                        const result = await response.json();
                        if (result.status === 'error') throw new Error(result.message);
                        return result;
                    } catch (error) {
                        alert('Terjadi kesalahan: ' + error.message);
                        this.isLoading = false; 
                        return { status: 'error' };
                    }
                },

                async loadInvoices() {
                    this.isLoading = true;
                    const result = await this.callApi({ action: 'readAllInvoice' });
                    if (result.status === 'success') {
                        // Pastikan mapping field sesuai data dari database
                        this.invoices = result.data.map(row => ({
                            ID_Invoice: row.ID_Invoice,
                            Nama: row.Nama,
                            Status: row.Status
                        }));
                    }
                    this.isLoading = false;
                },

                openModal(item = null) {
                    this.modal = item ? { isEdit: true, id_invoice: item.ID_Invoice, nama: item.Nama, status: item.Status } : { isEdit: false, id_invoice: null, nama: '', status: '' };
                    this.isModalOpen = true;
                },

                closeModal() { this.isModalOpen = false; },

                async saveInvoice() {
                    if (!this.modal.nama || !this.modal.status) {
                        alert('Nama dan Status tidak boleh kosong.');
                        return;
                    }
                    const payload = {
                        action: this.modal.isEdit ? 'updateInvoice' : 'createInvoice',
                        id_invoice: this.modal.id_invoice,
                        nama: this.modal.nama,
                        status: this.modal.status
                    };
                    const result = await this.callApi(payload);
                    if (result.status === 'success') {
                        this.closeModal();
                        this.loadInvoices();
                    }
                },

                openDeleteModal(item) {
                    this.itemToDelete = item;
                    this.isDeleteModalOpen = true;
                },

                closeDeleteModal() {
                    this.isDeleteModalOpen = false;
                    this.itemToDelete = null;
                },

                async confirmDelete() {
                    if (!this.itemToDelete) return;
                    const result = await this.callApi({ action: 'deleteInvoice', id_invoice: this.itemToDelete.ID_Invoice });
                    this.closeDeleteModal();
                    if (result.status === 'success') {
                        this.invoices = this.invoices.filter(k => k.ID_Invoice !== this.itemToDelete.ID_Invoice);
                    }
                }
            }
        }
    </script>
    
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

</head>

<body class="bg-gray-100" x-data="crudApp()" x-init="init()" x-cloak>
    
    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="text-2xl font-bold text-blue-600">Manajemen Invoice</div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
            <!-- Kolom Pencarian (Kiri) -->
            <div class="relative w-full sm:w-64">
                <input x-model.debounce.300ms="searchQuery" type="text" placeholder="Cari ID Invoice, nama, atau status..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm" />
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>
            
            <!-- Tombol Aksi (Kanan) -->
            <div class="flex items-center gap-4 w-full sm:w-auto">
                <button @click="loadInvoices()" :disabled="isLoading" class="flex items-center justify-center gap-2 bg-white text-gray-700 border border-gray-300 px-5 py-2.5 rounded-lg font-semibold h-[...]
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" :class="{'animate-spin': isLoading}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 20v-5h-5M4 4l1.5 1.5A9 9 0 0120.5 16l-1.5-1.5" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20 20l-1.5-1.5A9 9 0 003.5 8l1.5 1.5" />
                    </svg>
                    <span>Segarkan</span>
                </button>
                <button @click="openModal()" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg font-semibold hover:bg-blue-700 transition shadow-md w-full sm:w-auto">
                    Tambah Data
                </button>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-xl w-full">
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">ID Invoice</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Nama</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <template x-if="isLoading">
                            <template x-for="i in 5" :key="i">
                                <tr>
                                    <td class="py-4 px-6"><div class="h-4 rounded bg-gray-200 animate-shimmer"></div></td>
                                    <td class="py-4 px-6"><div class="h-4 rounded bg-gray-200 animate-shimmer"></div></td>
                                    <td class="py-4 px-6"><div class="h-4 rounded bg-gray-200 animate-shimmer"></div></td>
                                    <td class="py-4 px-6"><div class="h-4 rounded bg-gray-200 animate-shimmer"></div></td>
                                </tr>
                            </template>
                        </template>
                        
                        <template x-if="!isLoading && paginatedData.length === 0">
                            <tr><td colspan="4" class="text-center p-6 text-gray-500" x-text="invoices.length === 0 ? 'Belum ada data invoice.' : 'Data tidak ditemukan.'"></td></tr>
                        </template>
                        
                        <template x-if="!isLoading">
                            <template x-for="item in paginatedData" :key="item.ID_Invoice">
                                <tr class="hover:bg-gray-50 transition">
                                    <td class="py-4 px-6 whitespace-nowrap text-sm font-medium text-gray-900" x-text="item.ID_Invoice"></td>
                                    <td class="py-4 px-6 whitespace-nowrap text-sm text-gray-500" x-text="item.Nama"></td>
                                    <td class="py-4 px-6 whitespace-nowrap text-sm text-gray-500" x-text="item.Status"></td>
                                    <td class="py-4 px-6 whitespace-nowrap text-sm font-medium space-x-4">
                                        <button @click="openModal(item)" class="text-indigo-600 hover:text-indigo-900 font-semibold">Edit</button>
                                        <button @click="openDeleteModal(item)" class="text-red-600 hover:text-red-900 font-semibold">Hapus</button>
                                    </td>
                                </tr>
                            </template>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Kontrol Paginasi -->
            <div x-show="!isLoading && totalPages > 1" class="mt-4 flex justify-between items-center">
                <button @click="prevPage()" :disabled="currentPage === 1" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50">
                    Sebelumnya
                </button>
                <span class="text-sm text-gray-700">
                    Halaman <span x-text="currentPage" class="font-medium"></span> dari <span x-text="totalPages" class="font-medium"></span>
                </span>
                <button @click="nextPage()" :disabled="currentPage >= totalPages" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50">
                    Berikutnya
                </button>
            </div>
        </div>
    </main>

    <!-- Modal Tambah/Edit -->
    <div x-show="isModalOpen" @keydown.escape.window="closeModal()" class="fixed inset-0 z-50 overflow-y-auto flex items-center justify-center" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div x-show="isModalOpen" x-transition.opacity.duration.300ms class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="closeModal()"></div>
        <div x-show="isModalOpen" x-transition.duration.300ms class="inline-block bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full m-4">
            <form @submit.prevent="saveInvoice()">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title" x-text="modal.isEdit ? 'Edit Data Invoice' : 'Tambah Invoice Baru'"></h3>
                    <div class="mt-4 space-y-4">
                        <div>
                            <label for="modal-nama" class="block text-sm font-medium text-gray-700">Nama</label>
                            <input x-model="modal.nama" id="modal-nama" type="text" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required />
                        </div>
                        <div>
                            <label for="modal-status" class="block text-sm font-medium text-gray-700">Status</label>
                            <input x-model="modal.status" id="modal-status" type="text" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required />
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Simpan
                    </button>
                    <button @click="closeModal()" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:w-auto sm:text-sm">
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Konfirmasi Hapus -->
    <div x-show="isDeleteModalOpen" @keydown.escape.window="closeDeleteModal()" class="fixed inset-0 z-50 overflow-y-auto flex items-center justify-center" aria-labelledby="delete-modal-title" role="dialog" aria-modal="true">
        <div x-show="isDeleteModalOpen" x-transition.opacity.duration.300ms class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="closeDeleteModal()"></div>
        <div x-show="isDeleteModalOpen" x-transition.duration.300ms class="inline-block bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full m-4">
             <div class="bg-white px-4 pt-5 pb-4 sm:p-6">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="delete-modal-title">Hapus Data Invoice</h3>
                        <p class="text-sm text-gray-500 mt-2">Apakah Anda yakin ingin menghapus data ini? Tindakan ini tidak dapat dibatalkan.</p>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button @click="confirmDelete()" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Hapus
                </button>
                <button @click="closeDeleteModal()" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:w-auto sm:text-sm">
                    Batal
                </button>
            </div>
        </div>
    </div>

</body>
</html>
