<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Story Animator - Prompt Generator</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & Babel for JSX in browser -->
    <script src="https://unpkg.com/react@17/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <script>
        if (!sessionStorage.getItem('sessionToken')) {
            window.location.href = 'auth.html?reason=unauthorized';
        }
    </script>
    
    <style>
        /* Animasi Gradien untuk Latar Belakang */
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        body {
            font-family: 'Inter', sans-serif;
            color: #F9FAFB;
            background: linear-gradient(-45deg, #111827, #10172A, #1E1B4B, #3730A3);
            background-size: 400% 400%;
            animation: gradient-animation 20s ease infinite;
            overflow-x: hidden;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">
    <main id="main-content" class="w-full overflow-y-auto">
        <div id="prompt-maker-root" class="tool-view"></div>
    </main>

    <script type="text/babel">
        // --- ICONS ---
        const SparklesIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M5 3v4M3 5h4M19 3v4M17 5h4M12 3v4M10 5h4M5 21v-4M3 19h4M19 21v-4M17 19h4M12 21v-4M10 19h4M12 9a3 3 0 100-6 3 3 0 000 6zM5 15a3 3 0 100-6 3 3 0 000 6zM19 15a3 3 0 100-6 3 3 0 000 6z" /></svg>);
        const CopyIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>);
        const KeyIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-2 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 1 1 0 000-2z" clipRule="evenodd" /></svg>);

        function App() {
          const { useState, useCallback, useEffect } = React;

          const [apiKey, setApiKey] = useState('');
          const [storyIdea, setStoryIdea] = useState('Seorang ksatria pemberani menemukan pedang ajaib di hutan dan menggunakannya untuk melawan naga ganas yang meneror sebuah desa.');
          const [generatedScenes, setGeneratedScenes] = useState([]);
          const [generatedJson, setGeneratedJson] = useState('');
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState('');
          const [message, setMessage] = useState('');

          useEffect(() => {
            if (message || error) {
              const timer = setTimeout(() => {
                setMessage('');
                setError('');
              }, 5000);
              return () => clearTimeout(timer);
            }
          }, [message, error]);

          const generateDisplayJson = useCallback((scenes) => {
              if(!scenes || scenes.length === 0) return '';
              
              // These are the global settings that will be applied to each scene's JSON
              const renderSettings = {
                  outputResolution: "1080p (1920x1080)",
                  frameRate: "24 fps"
              };

              const allScenesJson = scenes.map(scene => {
                  const sceneDetails = { ...scene, durationInSeconds: 8 };
                  const finalSceneOutput = {
                      renderSettings: renderSettings,
                      sceneDetails: sceneDetails
                  };
                  return `// --- PROMPT ADEGAN ${scene.sceneNumber} ---\n` + JSON.stringify(finalSceneOutput, null, 2);
              }).join('\n\n');

              return allScenesJson;
          }, []);

          const handleGenerateStory = async () => {
            if (!apiKey) {
              setError('Silakan masukkan Google Gemini API Key Anda.');
              return;
            }
            if (!storyIdea) {
              setError('Silakan masukkan ide cerita Anda.');
              return;
            }

            setLoading(true);
            setError('');
            setMessage('');
            setGeneratedScenes([]);
            setGeneratedJson('');

            const systemPrompt = `Anda adalah sutradara animasi 3D dan penulis naskah ahli dengan gaya seperti Disney/Pixar. Tugas Anda adalah mengambil ide cerita dari pengguna dan mengubahnya menjadi rangkaian adegan animasi yang detail.

ATURAN KETAT:
1. Buat cerita yang koheren dan pecah menjadi 3 hingga 5 adegan.
2. Setiap adegan HARUS berdurasi 8 detik.
3. Deskripsi harus hidup, fokus pada visual, emosi, dan aksi.
4. Setiap adegan harus menyambung dengan mulus ke adegan berikutnya.
5. Anda HARUS menghasilkan output dalam format array JSON yang valid. Jangan tambahkan markdown atau teks lain di luar array JSON.

Struktur JSON untuk setiap adegan dalam array adalah sebagai berikut:
{
  "sceneNumber": <nomor_adegan>,
  "visualStyle": "<gaya_visual_seperti_Stylized_Toon_Shading>",
  "environmentType": "<tipe_lingkungan_seperti_Fantasi>",
  "environmentDescription": "<deskripsi_detail_lingkungan_dan_atmosfer>",
  "lightingStyle": "<gaya_pencahayaan>",
  "lightingDescription": "<deskripsi_detail_pencahayaan_dan_mood>",
  "objects": [
    {
      "objectType": "<Karakter/Makhluk/Properti>",
      "description": "<deskripsi_detail_penampilan_dan_kondisi_objek>",
      "materialType": "<tipe_material>"
    }
  ],
  "animationDescription": "<deskripsi_aksi_dan_animasi_yang_terjadi_dalam_8_detik>",
  "cameraAngle": "<sudut_kamera>",
  "cameraMovement": "<gerakan_kamera>",
  "focalLength": <panjang_fokus_dalam_mm>
}`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

            const payload = {
              contents: [{
                parts: [{ text: `Ide Cerita: "${storyIdea}"` }]
              }],
              systemInstruction: {
                parts: [{ text: systemPrompt }]
              },
              generationConfig: {
                responseMimeType: "application/json",
                temperature: 0.7,
              }
            };

            try {
              const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });

              if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error ? errorData.error.message : 'Respon jaringan tidak baik.');
              }

              const result = await response.json();
              const jsonText = result.candidates[0].content.parts[0].text;
              const scenesData = JSON.parse(jsonText);
              
              setGeneratedScenes(scenesData);
              setGeneratedJson(generateDisplayJson(scenesData));
              setMessage('Cerita dan adegan berhasil dibuat!');

            } catch (err) {
              setError(`Terjadi kesalahan: ${err.message}. Periksa API Key dan koneksi Anda.`);
              console.error(err);
            } finally {
              setLoading(false);
            }
          };
          
          const copyToClipboard = () => {
            if (!generatedJson) {
              setError('Buat prompt terlebih dahulu.');
              return;
            }
            try {
              const textarea = document.createElement('textarea');
              textarea.value = generatedJson;
              textarea.style.position = 'fixed';
              textarea.style.opacity = '0';
              document.body.appendChild(textarea);
              textarea.select();
              document.execCommand('copy');
              document.body.removeChild(textarea);
              setMessage('Prompt JSON berhasil disalin!');
            } catch (err) {
              console.error('Gagal menyalin: ', err);
              setError('Gagal menyalin prompt.');
            }
          };

          return (
            <div className="text-white p-4 sm:p-6 lg:p-8">
              <div className="max-w-5xl mx-auto bg-slate-800/50 backdrop-blur-xl rounded-2xl shadow-2xl shadow-black/50 p-6 sm:p-8 lg:p-10 border border-slate-700">
                <div className="text-center mb-10">
                  <h1 className="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-purple-400 mb-2" style={{ textShadow: '0 0 15px rgba(100, 255, 255, 0.5)' }}>
                    AI Story Animation Maker
                  </h1>
                  <h2 className="text-xl sm:text-2xl font-semibold text-slate-300">
                    Hasilkan Alur Cerita & Prompt Animasi Secara Otomatis
                  </h2>
                </div>

                {/* --- INPUT SECTION --- */}
                <div className="p-5 bg-slate-800/60 rounded-xl border border-slate-700 shadow-lg mb-8">
                  <div className="mb-4">
                    <label className="block text-slate-300 text-sm font-bold mb-2 flex items-center"><KeyIcon/> Google Gemini API Key</label>
                    <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="Masukkan API Key Anda di sini" className="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-yellow-400 transition-all duration-300" />
                  </div>
                  <div className="mb-4">
                    <label className="block text-slate-300 text-sm font-bold mb-2">Ide Cerita Anda</label>
                    <textarea value={storyIdea} onChange={(e) => setStoryIdea(e.target.value)} rows="3" placeholder="Contoh: Seekor rubah kecil yang ingin belajar terbang." className="w-full px-4 py-2 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all duration-300"></textarea>
                  </div>
                  <button onClick={handleGenerateStory} disabled={loading} className="w-full inline-flex justify-center items-center px-8 py-3 bg-gradient-to-r from-green-400 to-cyan-500 text-white font-bold rounded-lg hover:scale-105 transition-transform duration-200 shadow-lg shadow-cyan-500/30 text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    {loading ? <div className="loader" style={{width: '24px', height: '24px', borderTopColor: 'white'}}></div> : <><SparklesIcon /> Buat Cerita & Adegan</>}
                  </button>
                </div>

                {/* --- MESSAGES --- */}
                {error && (<div className="my-6 p-3 bg-red-900/50 text-red-300 border border-red-500/50 rounded-lg text-center font-medium">{error}</div>)}
                {message && (<div className="my-6 p-3 bg-slate-700/50 text-cyan-300 border border-cyan-400/50 rounded-lg text-center font-medium">{message}</div>)}

                {/* --- GENERATED SCENES PREVIEW --- */}
                {generatedScenes.length > 0 && (
                    <div className="mt-8">
                        <h3 className="text-2xl font-bold text-purple-300 mb-4 text-center">Hasil Alur Cerita</h3>
                        <div className="space-y-6">
                            {generatedScenes.map((scene) => (
                                <div key={scene.sceneNumber} className="p-5 bg-slate-900/50 rounded-xl border-2 border-slate-700 shadow-lg">
                                    <h4 className="text-xl font-bold text-cyan-300 mb-2">Adegan {scene.sceneNumber}</h4>
                                    <p className="text-slate-300"><strong className="font-semibold text-white">Lingkungan:</strong> {scene.environmentDescription}</p>
                                    <p className="text-slate-300 mt-2"><strong className="font-semibold text-white">Aksi (8 detik):</strong> {scene.animationDescription}</p>
                                    <p className="text-slate-300 mt-2"><strong className="font-semibold text-white">Kamera:</strong> {scene.cameraMovement}, {scene.cameraAngle}.</p>
                                </div>
                            ))}
                        </div>
                    </div>
                )}


                {/* --- JSON OUTPUT --- */}
                {generatedJson && (
                  <div className="mt-10 pt-8 border-t-2 border-slate-700">
                    <div className="flex flex-wrap justify-between items-center gap-y-3 mb-4">
                      <h3 className="text-xl font-bold text-cyan-300">Prompt JSON per Adegan:</h3>
                      <button onClick={copyToClipboard} className="flex items-center px-4 py-2 bg-gradient-to-r from-blue-400 to-purple-500 text-white font-semibold rounded-lg hover:scale-105 transition-transform duration-200 shadow-lg shadow-purple-500/30 text-sm">
                          <CopyIcon /> Salin Semua
                      </button>
                    </div>
                    <pre className="whitespace-pre-wrap font-mono text-sm text-slate-200 bg-black/30 p-4 rounded-md border border-slate-600 max-h-96 overflow-y-auto">{generatedJson}</pre>
                  </div>
                )}
              </div>
            </div>
          );
        }

        ReactDOM.render(<App />, document.getElementById('prompt-maker-root'));
    </script>
</body>
</html>


